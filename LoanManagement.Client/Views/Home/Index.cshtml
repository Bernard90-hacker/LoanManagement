@model ClientLoginViewModel
@{
    Layout = "_BlankLayout";
}

@section VendorStyles {
    <link rel="stylesheet" href="~/vendor/libs/formvalidation/dist/css/formValidation.min.css">
    <link rel="stylesheet" href="~/dist/colored-theme.min.css">
    <link rel="stylesheet" href="~/dist/dark-theme.min.css">
    <link rel="stylesheet" href="~/dist/light-theme.min.css">
    <link rel="stylesheet" href="~/vendor/libs/tagify/tagify.dist.css" />
    <link rel="stylesheet" href="~/vendor/libs/animate-css/animate.dist.css" />
    <link rel="stylesheet" href="~/vendor/libs/spinkit/spinkit.dist.css" />
    <link rel="stylesheet" href="~/vendor/libs/toastr/toastr.dist.css" />
    <link rel="stylesheet" href="~/vendor/libs/sweetalert2/sweetalert2.dist.css" />
}

@section VendorScripts {
    <script src="~/vendor/libs/formvalidation/dist/js/FormValidation.min.js"></script>
    <script src="~/vendor/libs/formvalidation/dist/js/plugins/Bootstrap5.min.js"></script>
    <script src="~/vendor/libs/formvalidation/dist/js/plugins/AutoFocus.min.js"></script>
    <script src="~/vendor/libs/cleavejs/cleave.dist.js"></script>
    <script src="~/vendor/libs/cleavejs/cleave-phone.dist.js"></script>
    <script src="~/vendor/libs/tagify/tagify.dist.js"></script>
    <script src="~/vendor/libs/block-ui/block-ui.dist.js"></script>
    <script src="~/vendor/libs/toastr/toastr.dist.js"></script>
    <script src="~/vendor/libs/sweetalert2/sweetalert2.dist.js"></script>
}

@section PageStyles {
    <link rel="stylesheet" href="~/vendor/css/pages/page-auth.dist.css">
}

@section PageScripts {
    <script src="~/js/pages-auth.dist.js"></script>
    <script src="~/dist/growl-notification.min.js">
    </script>
    <script src="~/js/custom/home-index.js"></script>
	<script>
		$(function () {
			var form = window.$('#myForm'),
				btn = window.$('#btnSubmit'),
				//indice = $('#indice'),
				//tel = $('#tel'),
				title = '',
				message = '',
				errorTitle = new DOMParser().parseFromString('Erreur', 'text/html').body.innerHTML,
				errorTypeMessage = 'error',
				errorMessage = new DOMParser().parseFromString('Erreur Produite', 'text/html').body.innerHTML,
				errorDescription = '',
				errorTimeOut = 500000,
				errors = [];

			form.on("submit",
				function (event) {
					event.preventDefault();
					var data = window.$(this).serialize();
					var url = window.$(this).attr("action");
					console.log(data);
					window.$.ajax({
						url: url,
						type: "POST",
						dataType: "json",
						data: data,
						beforeSend: function () {
							btn.attr('disabled', 'disabled');
							window.$.blockUI({
								message: '<div class="spinner-border text-primary" role="status"></div>',
								css: {
									backgroundColor: 'transparent',
									border: '0'
								},
								overlayCSS: {
									backgroundColor: '#fff',
									opacity: 0.8
								}
							});
						},
						success: function (response) {
							console.log(response);
							if(response.typeMessage === "error"){
								window.toastr[response.typeMessage]('👋 ' + 'Erreur, Identifiants incorrects.',
									{
										showMethod: 'slideDown',
										hideMethod: 'slideUp',
										closeButton: true,
										tapToDismiss: false,
										progressBar: true,
										timeOut: response.timeOut,
										rtl: window.$('html').attr('data-textdirection') === 'rtl',
										onHidden: function () { }
									});
							}
							var strJson = JSON.parse(response.strJsonLogin);
							var nom = strJson.Nom;
							var prenoms = strJson.Prenoms;
							indice.val(strJson.Indice);
							tel.val(strJson.Telephone);
							message = new DOMParser().parseFromString(response.message, 'text/html').body.innerHTML;
							window.toastr[response.typeMessage]('👋 ' + message,
								response.title,
								{
									showMethod: 'slideDown',
									hideMethod: 'slideUp',
									closeButton: true,
									tapToDismiss: false,
									progressBar: true,
									timeOut: response.timeOut,
									rtl: window.$('html').attr('data-textdirection') === 'rtl',
									onHidden: function () { }
								});
							window.location.href = "https://localhost:44309/DemandeCredit";
						},
						error: function (response) {
							try {
								//window.location.href = "https://localhost:44309/DemandeCredit";
								var obj = JSON.parse(JSON.stringify(response.responseJSON));
								if (obj.length !== 0) {
									if (response.status === 401) {
										message = new DOMParser().parseFromString('Non autorisé', 'text/html').body.innerHTML;
										window.toastr[errorTypeMessage]('👋 ' + message,
											errorTitle,
											{
												showMethod: 'slideDown',
												hideMethod: 'slideUp',
												closeButton: true,
												tapToDismiss: false,
												progressBar: true,
												timeOut: errorTimeOut,
												rtl: window.$('html').attr('data-textdirection') === 'rtl'
											});
									}
									else {
										if (obj.typeMessage != null && obj.typeMessage !== undefined) {
											if (response.status === 0) {
											} else if (response.status === 400 || response.status === 404 || response.status === 405 || response.status === 500) {
												errorTitle = obj.title;
												errorTypeMessage = obj.typeMessage;
												errorMessage = obj.message;
												errorDescription = obj.description;
												errorTimeOut = obj.timeOut;
												if (obj.erreurs != null && obj.erreurs != undefined) errors = obj.erreurs;
											}
											if (errors !== null && errors !== undefined && errors.length > 0) {
												var messages = '';
												if (errors.length == 1) {
													messages = errors;
												}
												else {
													for (var i = 0; i < errors.length; i++) {
														messages += errors[i] + "<br>";
													}
													messages = messages.slice(0, -4);
												}
												errorMessage = new DOMParser().parseFromString(messages, 'text/html').body.innerHTML;

											} else if (errorDescription !== null && errorDescription !== undefined) {
												errorMessage = new DOMParser().parseFromString(errorDescription, 'text/html').body.innerHTML;
											} else {
												errorMessage = new DOMParser().parseFromString(errorMessage, 'text/html').body.innerHTML;
											}
											window.toastr[errorTypeMessage]('👋 ' + errorMessage,
												errorTitle,
												{
													showMethod: 'slideDown',
													hideMethod: 'slideUp',
													closeButton: true,
													tapToDismiss: false,
													progressBar: true,
													timeOut: errorTimeOut,
													rtl: window.$('html').attr('data-textdirection') === 'rtl'
												});
										}
									}
								}
							} catch (err) {
								window.toastr[errorTypeMessage]('👋 ' + err,
									errorTitle,
									{
										showMethod: 'slideDown',
										hideMethod: 'slideUp',
										closeButton: true,
										tapToDismiss: false,
										progressBar: true,
										timeOut: errorTimeOut,
										rtl: window.$('html').attr('data-textdirection') === 'rtl'
									});
							}
						},
						complete: function () {
							btn.removeAttr('disabled');
							window.$.unblockUI();
						}
					});
				});
		});
	</script>
}

@* ************** Content ************** *@

<div class="container-xxl">
    <div class="authentication-wrapper authentication-basic container-p-y">
        <div class="authentication-inner py-4">
            <!-- Login -->
            <div class="card">
                <div class="card-body">
                    <!-- Logo -->
                    <div class="app-brand justify-content-center mb-4 mt-2">
                        <a href="/" class="app-brand-link gap-2">
                            <span class="app-brand-logo demo">@await Html.PartialAsync("../_Partials/_Macros")</span>
                            <span class="app-brand-text demo text-body fw-bold ms-1">Loan Application</span>
                        </a>
                    </div>
                    <!-- /Logo -->
                    <h4 class="mb-1 pt-2">Welcome to Loan Application</h4>
                    <p class="mb-4">Please sign-in to your account and start the adventure</p>

                    <form id="myForm" class="mb-3" method="post" asp-action="Login" asp-controller="Home">				
                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                        <div class="mb-3">
                            <label for="indice" class="form-label" asp-for="@Model.ClientLoginResource.Indice">Indice</label>
							<input type="text" class="form-control" id="indice" placeholder="Entrez votre indice" autofocus asp-for="@Model.ClientLoginResource.Indice">
                        </div>
                        <div class="mb-3 form-password-toggle">
                            <div class="d-flex justify-content-between">
                                <label class="form-label" for="tel">Téléphone</label>
                            </div>
                            <div class="input-group input-group-merge">
                                <input type="tel" id="tel" class="form-control" asp-for="@Model.ClientLoginResource.Telephone" aria-describedby="tel" />
                                <span class="input-group-text cursor-pointer"><i class="ti ti-eye-off"></i></span>
                            </div>
                        </div>
                        @*<div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="remember-me">
                                <label class="form-check-label" for="remember-me">
                                    Remember Me
                                </label>
                            </div>
                        </div>*@
                        <div class="mb-3">
                            <button class="btn btn-primary d-grid w-100" type="submit" id="btnSubmit">Sign in</button>
                        </div>
                    </form>
                    

            
                </div>
            </div>
            <!-- /Register -->
        </div>
    </div>
</div>
@*@{
    if (ViewBag.IsSuccess != null)
    {
        <script>
            alert('Identifiants incorrects.');
        </script>
    }
}*@

